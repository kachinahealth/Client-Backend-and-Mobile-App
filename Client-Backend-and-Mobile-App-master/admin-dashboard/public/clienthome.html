<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KachinaHealth - Client Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 25%, #e0f2f1 50%, #f1f8e9 75%, #f9fbe7 100%);
            min-height: 100vh;
        }
        
        /* Add new style for centered dashboard title */
        .dashboard-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            text-align: center;
            flex: 1;                          /* take up remaining space */
        }
        
        /* Update header layout */
        .header {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 25%, #26a69a 50%, #66bb6a 75%, #9ccc65 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            min-height: 80px;
        }

        /* Clinical Trials Dropdown */
        .clinical-trials-dropdown {
            position: relative;
            margin: 0 2rem;
        }

        .dropdown-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .dropdown-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .dropdown-icon {
            font-size: 1.1rem;
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .clinical-trials-dropdown.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
            max-height: 400px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .clinical-trials-dropdown.active .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f3f4f6;
            background: #f8fafc;
        }

        .dropdown-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .trial-count {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .trial-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .trial-loading {
            padding: 2rem;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        .trial-item {
            display: block;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f3f4f6;
            text-decoration: none;
            color: #1f2937;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .trial-item:hover {
            background: #f8fafc;
        }

        .trial-item:last-child {
            border-bottom: none;
        }

        .trial-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            display: block;
        }

        .trial-company {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .trial-status {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .trial-status.status-active {
            background: #dcfce7;
            color: #166534;
        }

        .trial-status.status-completed {
            background: #dbeafe;
            color: #1e40af;
        }

        .trial-status.status-paused {
            background: #fef3c7;
            color: #92400e;
        }

        .trial-status.status-cancelled {
            background: #fee2e2;
            color: #dc2626;
        }

        .dropdown-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid #f3f4f6;
            background: #f8fafc;
            text-align: center;
        }

        .view-all-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .view-all-btn:hover {
            background: #5a67d8;
        }
        
        .logo {
            display: flex;
            align-items: center;
            background: #1e1e1e;
            padding: 0.75rem;
            border-radius: 15px;
            display: inline-block;
            width: fit-content;
        }
        
        .kachina-logo {
            width: 280px;
            height: auto;
            max-height: 80px;
            display: block;
            object-fit: contain;
            margin: 0;
        }
        
        /* Update company info layout */
        .company-info {
            display: flex;
            align-items: center;
            gap: 1rem;                        /* space between logout and logo */
        }
        
        .company-logo {
            width: 280px;                     /* match KachinaHealth logo width */
            height: 80px;                     /* match KachinaHealth logo height */
            margin-left: 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            object-fit: contain;
            background: white;
            padding: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .fallback-logo {
            width: 120px;
            height: 40px;
            margin-left: 1rem;
            border-radius: 4px;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .company-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid rgba(38, 166, 154, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(38, 166, 154, 0.15);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #1976d2, #26a69a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .tabs {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab-button {
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            margin-right: 0.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
        }
        
        .tab-button.active {
            background: white;
            color: #1976d2;
            border-bottom-color: #26a69a;
            box-shadow: 0 -2px 10px rgba(38, 166, 154, 0.1);
        }
        
        .tab-content {
            padding: 2rem;
            display: none;
            background: white;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-top: -1px;
            border: 1px solid rgba(38, 166, 154, 0.1);
            border-top: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .user-table th,
        .user-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        .status-pending {
            color: #f57c00;
            font-weight: 500;
        }
        
        .status-approved {
            color: #388e3c;
            font-weight: 500;
        }
        
        .status-rejected {
            color: #d32f2f;
            font-weight: 500;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }
        
        .btn-approve {
            background: #4caf50;
            color: white;
        }
        
        .btn-reject {
            background: #f44336;
            color: white;
        }
        
        .news-form {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group-wide {
            flex: 2;
            margin-right: 1rem;
        }

        .form-group-narrow {
            flex: 1;
            margin-right: 1rem;
        }

        .form-group-narrow:last-child {
            margin-right: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn-primary {
            background: #1976d2;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .alert-error {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }

        /* Content tabs for News & Updates */
        .content-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .content-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s;
        }
        
        .content-tab.active {
            color: #1976d2;
            border-bottom: 2px solid #1976d2;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }

        /* PDF Form Styles */
        .pdf-form {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .pdf-item {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid #1976d2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-info h5 {
            margin-bottom: 0.25rem;
        }

        .category-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        .pdf-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* PDF Viewer Modal Styles */
        .pdf-modal {
            max-width: 90vw;
            width: 1200px;
            height: 80vh;
        }

        .pdf-viewer-container {
            background: #f5f5f5;
            border-radius: 4px;
            padding: 1rem;
            height: 100%;
        }

        #pdfViewerFrame {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        /* Basic Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .modal-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Leaderboard Styles */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-stat {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .summary-stat h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .form-row:not(:first-child) .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e0e0e0); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #deb887); }

        .btn-edit {
            background: #2196f3;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .editing-row {
            background-color: #e3f2fd !important;
            box-shadow: 0 0 10px rgba(25, 118, 210, 0.3);
        }

        .other-rows {
            opacity: 0.6;
        }

        /* Debug Panel Styles */
        .debug-panel {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .debug-panel h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .debug-panel pre {
            background: #333;
            color: #00ff00;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .debug-panel button {
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }

        #restoreForm {
            display: none;
            margin-top: 1rem;
        }

        #restoreForm textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 1rem;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .analytics-filters {
            margin-bottom: 2rem;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }

        .analytics-table-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .analytics-table th,
        .analytics-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .analytics-table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .user-analytics-chart {
            height: 300px;
            margin: 2rem 0;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-approved {
            background-color: #28a745;
            color: white;
        }

        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .status-revoked {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="logos/logo.png" alt="KachinaHealth Logo" class="kachina-logo">
        </div>
        
        <h1 class="dashboard-title">CereVasc App Dashboard</h1>

        <!-- Clinical Trials Dropdown -->
        <div class="clinical-trials-dropdown">
            <button class="dropdown-toggle" onclick="toggleTrialsDropdown()">
                <span class="dropdown-icon">ðŸ§ª</span>
                Clinical Trials
                <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="dropdown-menu" id="trialsDropdown">
                <div class="dropdown-header">
                    <h4>Available Clinical Trials</h4>
                    <span class="trial-count" id="trialCount">0</span>
                </div>
                <div class="trial-list" id="trialList">
                    <div class="trial-loading">Loading trials...</div>
                </div>
                <div class="dropdown-footer">
                    <button onclick="showTab(3)" class="view-all-btn">Manage Trials</button>
                </div>
            </div>
        </div>

        <div class="company-info">
            <button onclick="logout()" class="logout-button">Logout</button>
            <img id="companyLogo" src="logos/cerevasc-logo.png" alt="CereVasc Logo" class="company-logo">
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingApprovals">-</div>
                <div class="stat-label">Pending Approvals</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">-</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newsItems">-</div>
                <div class="stat-label">News Items</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab(0)">User Management</button>
                <button class="tab-button" onclick="showTab(1)">News & Updates</button>
                <button class="tab-button" onclick="showTab(2)">Enrollment Leaderboard</button>
                <button class="tab-button" onclick="showTab(3)">Clinical Trials</button>
                <button class="tab-button" onclick="showTab(4)">Training Materials</button>
                <button class="tab-button" onclick="showTab(5)">Study Protocol</button>
                <button class="tab-button" onclick="showTab(6)">Analytics</button>
                <button class="tab-button" onclick="showTab(7)">Settings</button>
            </div>

            <div class="tab-content active" id="tab0">
                <h3>User Management</h3>
                <div class="alert alert-success" id="userAlert"></div>

                <!-- Add/Edit User Form -->
                <div class="news-form">
                    <h4 id="userFormTitle">Add New User</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userName">Name</label>
                            <input type="text" id="userName" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" placeholder="Enter email address">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userSite">Site</label>
                            <input type="text" id="userSite" placeholder="Enter site/location">
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                                <option value="doctor">Doctor</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" onclick="saveUser()" id="saveUserBtn">Add User</button>
                        <button class="btn" onclick="cancelUserEdit()" id="cancelUserEditBtn" style="display: none;">Cancel Edit</button>
                    </div>
                </div>

                <!-- Users Table -->
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Site</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr><td colspan="6">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="tab-content" id="tab1">
                <h3>News & Updates</h3>
                <div class="alert alert-success" id="newsAlert"></div>
                
                <div class="content-tabs">
                    <button class="content-tab active" onclick="showContentTab('news')">News Items</button>
                    <button class="content-tab" onclick="showContentTab('pdfs')">PDF Documents</button>
                </div>

                <div class="content-section active" id="newsSection">
                    <div class="news-form">
                        <h4 id="newsFormTitle">Add News Item</h4>
                        <div class="form-group">
                            <label for="newsTitle">News Title</label>
                            <input type="text" id="newsTitle" placeholder="Enter news title">
                        </div>
                        <div class="form-group">
                            <label for="newsContent">News Content</label>
                            <textarea id="newsContent" placeholder="Enter news content"></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn-primary" id="newsSubmitBtn" onclick="saveNews()">Add News</button>
                            <button class="btn" id="newsCancelBtn" onclick="cancelNewsEdit()" style="display: none;">Cancel</button>
                        </div>
                    </div>
                    <div id="newsList" style="margin-top: 2rem;">
                        <h4>Recent News</h4>
                        <div id="newsItemsList">Loading news...</div>
                    </div>
                </div>

                <div class="content-section" id="pdfSection">
                    <div class="pdf-form">
                        <h4>Upload PDF Document</h4>
                        <div class="form-group">
                            <label for="pdfTitle">Document Title</label>
                            <input type="text" id="pdfTitle" placeholder="Enter document title">
                        </div>
                        <div class="form-group">
                            <label for="pdfDescription">Description</label>
                            <textarea id="pdfDescription" placeholder="Enter document description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="pdfCategory">Category</label>
                            <input type="text" id="pdfCategory" placeholder="e.g., Training, Updates, Guidelines">
                        </div>
                        <div class="form-group">
                            <label for="pdfFile">PDF File</label>
                            <input type="file" id="pdfFile" accept=".pdf">
                        </div>
                        <button class="btn-primary" onclick="addPDFDocument()">Upload PDF</button>
                    </div>
                    <div id="pdfList" style="margin-top: 2rem;">
                        <h4>PDF Documents</h4>
                        <div id="pdfItemsList">Loading PDFs...</div>
                    </div>
                </div>

                <!-- PDF Viewer Modal -->
                <div id="pdfViewerModal" class="modal" style="display: none;">
                    <div class="modal-content pdf-modal">
                        <div class="modal-header">
                            <h3 id="pdfModalTitle">PDF Viewer</h3>
                            <span class="close" onclick="closePDFViewer()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="pdf-viewer-container">
                                <iframe id="pdfViewerFrame" src="" width="100%" height="600px" frameborder="0"></iframe>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="downloadCurrentPDF()">Download PDF</button>
                            <button class="btn" onclick="closePDFViewer()">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab2">
                <h3>Enrollment Leaderboard</h3>
                <div class="alert alert-success" id="leaderboardAlert"></div>
                
                <!-- Trial Summary -->
                <div class="summary-stats">
                    <div class="summary-stat">
                        <h3 id="totalConsented">0</h3>
                        <p>Total Consented</p>
                    </div>
                    <div class="summary-stat">
                        <h3 id="totalRandomized">0</h3>
                        <p>Total Randomized</p>
                    </div>
                    <div class="summary-stat">
                        <h3 id="totalHospitals">0</h3>
                        <p>Participating Sites</p>
                    </div>
                </div>

                <!-- Add/Edit Hospital Form -->
                <div class="news-form">
                    <h4 id="hospitalFormTitle">Add New Hospital</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hospitalName">Hospital Name</label>
                            <input type="text" id="hospitalName" placeholder="Enter hospital name">
                        </div>
                        <div class="form-group">
                            <label for="hospitalLocation">Location</label>
                            <input type="text" id="hospitalLocation" placeholder="City, State/Country">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="principalInvestigator">Principal Investigator</label>
                        <input type="text" id="principalInvestigator" placeholder="Enter Principal Investigator's name">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="consentedPatients">Consented Patients</label>
                            <input type="number" id="consentedPatients" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="randomizedPatients">Randomized Patients</label>
                            <input type="number" id="randomizedPatients" placeholder="0" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="consentRate">Consent Rate (per month)</label>
                        <input type="number" id="consentRate" placeholder="0" min="0" step="0.1">
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" onclick="saveHospital()" id="saveHospitalBtn">Add Hospital</button>
                        <button class="btn" onclick="cancelEdit()" id="cancelEditBtn" style="display: none;">Cancel Edit</button>
                    </div>
                </div>

                <!-- Leaderboard Table -->
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Hospital</th>
                            <th>Location</th>
                            <th>Principal Investigator</th>
                            <th>Consented</th>
                            <th>Randomized</th>
                            <th>Rate/Month</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody">
                        <tr><td colspan="8">Loading leaderboard...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="tab-content" id="tab3">
                <h3>Clinical Trials</h3>
                <div class="alert alert-success" id="trialAlert"></div>

                <!-- Add/Edit Trial Form -->
                <div class="news-form">
                    <h4 id="trialFormTitle">Add New Clinical Trial</h4>
                    <div class="form-row">
                        <div class="form-group form-group-wide">
                            <label for="trialName">Clinical Trial Name *</label>
                            <input type="text" id="trialName" placeholder="Enter trial name" required>
                        </div>
                        <div class="form-group form-group-narrow">
                            <label for="trialStartDate">Start Date</label>
                            <input type="date" id="trialStartDate">
                        </div>
                        <div class="form-group form-group-narrow">
                            <label for="trialEndDate">End Date</label>
                            <input type="date" id="trialEndDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trialDescription">Description</label>
                            <textarea id="trialDescription" placeholder="Enter trial description" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="trialStatus">Status</label>
                            <select id="trialStatus">
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="paused">Paused</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn-primary" onclick="saveTrial()" id="saveTrialBtn">Add Trial</button>
                        <button class="btn" onclick="cancelTrialEdit()" id="cancelTrialEditBtn" style="display: none;">Cancel Edit</button>
                    </div>
                </div>

                <!-- Trials Table -->
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Trial Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trialsTableBody">
                        <!-- Trials will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="tab-content" id="tab4">
                <h3>Training Materials</h3>
                <div class="alert alert-success" id="trainingAlert"></div>
                
                <div class="content-tabs">
                    <button class="content-tab active" onclick="showTrainingContentTab('materials')">View Materials</button>
                    <button class="content-tab" onclick="showTrainingContentTab('upload')">Upload New</button>
                </div>

                <div class="content-section active" id="trainingMaterialsSection">
                    <h4>Available Training Materials</h4>
                    <div id="trainingMaterialsList">Loading training materials...</div>
                </div>

                <div class="content-section" id="trainingUploadSection">
                    <div class="news-form">
                        <div class="form-group">
                            <label for="trainingTitle">Title</label>
                            <input type="text" id="trainingTitle" placeholder="Enter training material title">
                        </div>
                        <div class="form-group">
                            <label for="trainingDescription">Description</label>
                            <textarea id="trainingDescription" placeholder="Enter description"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="trainingType">Type</label>
                                <select id="trainingType" onchange="toggleTrainingUploadOptions()">
                                    <option value="">Select type</option>
                                    <option value="text">Text Content</option>
                                    <option value="pdf">PDF Document</option>
                                    <option value="video">Video File</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="trainingCategory">Category</label>
                                <select id="trainingCategory">
                                    <option value="General">General</option>
                                    <option value="Safety">Safety Training</option>
                                    <option value="Procedure">Procedure Training</option>
                                    <option value="Compliance">Compliance</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="textContentSection" style="display: none;">
                            <div class="form-group">
                                <label for="trainingTextContent">Text Content</label>
                                <textarea id="trainingTextContent" placeholder="Enter the training content" rows="10"></textarea>
                            </div>
                        </div>
                        
                        <div id="fileUploadSection" style="display: none;">
                            <div class="form-group">
                                <label for="trainingFile">Upload File</label>
                                <input type="file" id="trainingFile" accept=".pdf,.mp4,.avi,.mov,.wmv">
                                <small>Supported formats: PDF, MP4, AVI, MOV, WMV</small>
                            </div>
                        </div>
                        
                        <button class="btn-primary" onclick="addTrainingMaterial()">Add Training Material</button>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab4">
                <h3>Study Protocol</h3>
                <div class="alert alert-success" id="protocolAlert"></div>
                
                <div class="content-tabs">
                    <button class="content-tab active" onclick="showProtocolContentTab('protocols')">View Protocols</button>
                    <button class="content-tab" onclick="showProtocolContentTab('upload')">Upload New</button>
                </div>

                <div class="content-section active" id="studyProtocolsSection">
                    <h4>Available Study Protocols</h4>
                    <div id="studyProtocolsList">Loading study protocols...</div>
                </div>

                <div class="content-section" id="protocolUploadSection">
                    <div class="news-form">
                        <div class="form-group">
                            <label for="protocolTitle">Protocol Title</label>
                            <input type="text" id="protocolTitle" placeholder="Enter protocol title">
                        </div>
                        <div class="form-group">
                            <label for="protocolDescription">Description</label>
                            <textarea id="protocolDescription" placeholder="Enter description"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="protocolType">Type</label>
                                <select id="protocolType" onchange="toggleProtocolUploadOptions()">
                                    <option value="">Select type</option>
                                    <option value="text">Text Document</option>
                                    <option value="pdf">PDF Document</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="protocolVersion">Version</label>
                                <input type="text" id="protocolVersion" placeholder="e.g., 1.0, 2.1" value="1.0">
                            </div>
                        </div>
                        
                        <div id="protocolTextContentSection" style="display: none;">
                            <div class="form-group">
                                <label for="protocolTextContent">Protocol Content</label>
                                <textarea id="protocolTextContent" placeholder="Enter the protocol content" rows="15"></textarea>
                            </div>
                        </div>
                        
                        <div id="protocolFileUploadSection" style="display: none;">
                            <div class="form-group">
                                <label for="protocolFile">Upload PDF</label>
                                <input type="file" id="protocolFile" accept=".pdf">
                                <small>Supported formats: PDF only</small>
                            </div>
                        </div>
                        
                        <button class="btn-primary" onclick="addStudyProtocol()">Add Study Protocol</button>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab5">
                <h3>Analytics</h3>
                
                <div class="analytics-header">
                    <h4>User Engagement Analytics</h4>
                    <button onclick="refreshAnalytics()" class="btn-primary">
                        <i class="fas fa-sync"></i> Refresh Data
                    </button>
                </div>

                <div class="analytics-filters">
                    <select id="analyticsFilter" onchange="filterAnalytics()">
                        <option value="all">All Users</option>
                        <option value="active">Active Users (Last 7 Days)</option>
                        <option value="inactive">Inactive Users (No Activity > 30 Days)</option>
                    </select>
                </div>

                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h5>Overall Engagement</h5>
                        <div class="stat-number" id="totalAppOpens">-</div>
                        <div class="stat-label">Total App Opens</div>
                    </div>
                    <div class="analytics-card">
                        <h5>Active Users</h5>
                        <div class="stat-number" id="activeUsers">-</div>
                        <div class="stat-label">Users Active in Last 7 Days</div>
                    </div>
                </div>

                <div class="analytics-table-container">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Site</th>
                                <th>Last Active</th>
                                <th>Total App Opens</th>
                                <th>Most Viewed Tab</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="analyticsTableBody">
                            <tr><td colspan="6">Loading analytics...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- User Details Modal -->
                <div id="userAnalyticsModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h4>User Analytics Details</h4>
                        <div id="userAnalyticsDetails"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab6">
                <h3>Company Settings</h3>
                <p>Company configuration and preferences will be managed here.</p>
                <p>This could include:</p>
                <ul style="margin-left: 2rem; margin-top: 1rem;">
                    <li>Notification preferences</li>
                    <li>Auto-approval settings</li>
                    <li>Branding customization</li>
                    <li>Security settings</li>
                </ul>
            </div>

            <div class="tab-content" id="tab7">
                <h3>Debug & Troubleshooting</h3>
                
                <div class="debug-panel">
                    <h4>Logo Loading Status</h4>
                    <pre id="logoDebugInfo">Checking logo loading...</pre>
                </div>

                <div class="debug-panel">
                    <h4>Company Information</h4>
                    <pre id="companyDebugInfo">Loading company info...</pre>
                </div>

                <div class="debug-panel">
                    <h4>Logo Test Links</h4>
                    <button onclick="testLogoAccess()">Test Logo Access</button>
                    <div id="logoTestResults" style="margin-top: 1rem;"></div>
                </div>

                <div class="debug-panel">
                    <h4>API Testing</h4>
                    <button onclick="testHospitalAPI()">Test Hospital API</button>
                    <button onclick="testServerConnectivity()">Test Server Connection</button>
                    <button onclick="testBasicEndpoint()">Test Basic Endpoint</button>
                    <button onclick="checkAvailableEndpoints()">Check Endpoints</button>
                    <pre id="apiTestResults">Click buttons to test APIs...</pre>
                </div>

                <div class="debug-panel">
                    <h4>Data Management</h4>
                    <button onclick="exportCurrentData()">Export Current Data</button>
                    <button onclick="showRestoreForm()">Restore Data</button>
                    <button onclick="exportFromLeaderboard()">Export from Leaderboard</button>
                    
                    <div id="restoreForm">
                        <h5>Paste your backup data below:</h5>
                        <textarea id="restoreDataTextarea" placeholder="Paste your JSON backup data here..."></textarea>
                        <button class="btn-primary" onclick="restoreData()">Restore Data</button>
                        <button class="btn" onclick="hideRestoreForm()">Cancel</button>
                    </div>
                    
                    <div id="exportResults" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCompany = '';
        let companyInfo = null;
        let editingHospitalId = null;

        // Initialize dashboard
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentCompany = urlParams.get('company');
            
            if (!currentCompany) {
                // Default to cerevasc if no company specified
                currentCompany = 'cerevasc';
            }

            // Load company info from localStorage or set defaults
            const stored = localStorage.getItem('companyInfo');
            if (stored) {
                companyInfo = JSON.parse(stored);
            } else {
                companyInfo = {
                    name: currentCompany === 'cerevasc' ? 'CereVasc' : 'Medtronic',
                    logoUrl: currentCompany === 'cerevasc' 
                        ? 'http://localhost:3000/logos/cerevasc-logo.png'
                        : 'http://localhost:3000/logos/medtronic-logo.svg'
                };
                // Store for future use
                localStorage.setItem('companyInfo', JSON.stringify(companyInfo));
            }
            
            // Update dashboard title with company name
            const dashboardTitle = document.querySelector('.dashboard-title');
            if (dashboardTitle) {
                dashboardTitle.textContent = `${companyInfo.name} App Dashboard`;
            }

            // Load logo with enhanced error handling
            const logoImg = document.getElementById('companyLogo');
            const fallbackLogo = document.getElementById('fallbackLogo');
            
            // Set a timeout for slow loading
            const logoTimeout = setTimeout(() => {
                logoImg.style.display = 'none';
                fallbackLogo.textContent = companyInfo.name;
                fallbackLogo.style.display = 'flex';
            }, 5000);
            
               logoImg.onload = function() {
                   clearTimeout(logoTimeout);
                logoImg.style.display = 'inline-block';
                fallbackLogo.style.display = 'none';
            };
            
            logoImg.onerror = function() {
                console.error('âŒ Failed to load logo:', companyInfo.logoUrl);
                clearTimeout(logoTimeout);
                
                // Try alternative paths
                if (companyInfo.logoUrl.includes('.svg')) {
                    console.log('ðŸ”„ Trying PNG version...');
                    const pngUrl = companyInfo.logoUrl.replace('.svg', '.png');
                    logoImg.src = pngUrl;
                    return;
                }
                
                if (!companyInfo.logoUrl.includes('localhost')) {
                    console.log('ðŸ”„ Trying localhost...');
                    logoImg.src = `http://localhost:3000/logos/${currentCompany}-logo.png`;
                    return;
                }
                
                console.log('ðŸ”„ Trying relative path...');
                logoImg.src = `./logos/${currentCompany}-logo.png`;
                
                // Final fallback
                setTimeout(() => {
                    logoImg.style.display = 'none';
                    fallbackLogo.textContent = companyInfo.name;
                    fallbackLogo.style.display = 'flex';
                }, 2000);
            };
            
            logoImg.src = companyInfo.logoUrl;
            
            loadDashboardData();
            loadPDFDocuments();
            loadLeaderboard();
            testLogoAccess();
            testServerConnectivity();
        };

        function showTab(index) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab
            tabContents[index].classList.add('active');
            tabButtons[index].classList.add('active');

            // Load trials when Clinical Trials tab is shown
            if (index === 3) {
                loadTrials();
            }
        }

        function showContentTab(tabName) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all content tabs
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            if (tabName === 'news') {
                document.getElementById('newsSection').classList.add('active');
                document.querySelector('.content-tab[onclick="showContentTab(\'news\')"]').classList.add('active');
            } else if (tabName === 'pdfs') {
                document.getElementById('pdfSection').classList.add('active');
                document.querySelector('.content-tab[onclick="showContentTab(\'pdfs\')"]').classList.add('active');
                loadPDFDocuments(); // Refresh PDFs when tab is shown
            }
        }

        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('token');

                // Load dashboard stats
                const statsResponse = await fetch('http://localhost:5000/api/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const statsData = await statsResponse.json();

                if (statsResponse.ok && statsData.success) {
                    document.getElementById('totalUsers').textContent = statsData.totalUsers;
                    document.getElementById('pendingApprovals').textContent = statsData.pendingApprovals;
                    document.getElementById('activeUsers').textContent = statsData.activeUsers;
                    document.getElementById('newsItems').textContent = statsData.newsItems;
                }

                // Load users, news, leaderboard, etc. separately
                await Promise.all([
                    loadUsers(),
                    loadNewsItems(),
                    loadLeaderboard(),
                    loadPDFDocuments()
                ]);
            } catch (error) {
                console.error('âŒ Error loading dashboard data:', error);
            }
        }

        function updateStats(stats) {
            console.log('ðŸ”„ Updating stats with:', stats);
            try {
                const totalUsersEl = document.getElementById('totalUsers');
                const pendingApprovalsEl = document.getElementById('pendingApprovals');
                const activeUsersEl = document.getElementById('activeUsers');
                const newsItemsEl = document.getElementById('newsItems');
                
                if (totalUsersEl) totalUsersEl.textContent = stats.totalUsers;
                if (pendingApprovalsEl) pendingApprovalsEl.textContent = stats.pendingApprovals;
                if (activeUsersEl) activeUsersEl.textContent = stats.activeUsers;
                if (newsItemsEl) newsItemsEl.textContent = stats.newsItems;
                
                console.log('âœ… Stats updated successfully');
            } catch (error) {
                console.error('âŒ Error updating stats:', error);
            }
        }

        async function loadUsers() {
            try {
                // Temporary: Remove authentication for testing
                const response = await fetch('http://localhost:5000/api/users', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateUserTable(data.users);
                } else {
                    updateUserTable([]);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                updateUserTable([]);
            }
        }

        function updateUserTable(users) {
            const tbody = document.getElementById('userTableBody');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.site}</td>
                    <td>${user.role}</td>
                    <td>
                        <span class="status-badge status-${user.status.toLowerCase()}">
                            ${user.status}
                        </span>
                    </td>
                    <td>
                        <button onclick="editUser('${user.id}')" class="btn-small">Edit</button>
                        <button onclick="deleteUser('${user.id}')" class="btn-delete">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateNewsList(news) {
            const newsList = document.getElementById('newsItemsList');
            
            if (news.length === 0) {
                newsList.innerHTML = '<p>No news items found</p>';
                return;
            }

            newsList.innerHTML = news.map(item => `
                <div style="background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border-left: 4px solid #1976d2;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h5 style="margin-bottom: 0.5rem;">${item.title}</h5>
                            <p style="color: #666; margin-bottom: 0.5rem;">${item.content}</p>
                            <small style="color: #999;">${item.date}${item.updatedDate ? ` (Updated: ${item.updatedDate})` : ''}</small>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                            <button class="btn-edit" data-news-id="${item.id}" data-news-title="${item.title}" data-news-content="${item.content}">Edit</button>
                            <button class="btn-delete" data-news-id="${item.id}">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Attach event listeners to edit and delete buttons
            newsList.querySelectorAll('.btn-edit').forEach(button => {
                button.addEventListener('click', function() {
                    const newsId = this.getAttribute('data-news-id');
                    const title = this.getAttribute('data-news-title');
                    const content = this.getAttribute('data-news-content');
                    editNews(newsId, title, content);
                });
            });

            newsList.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', function() {
                    const newsId = this.getAttribute('data-news-id');
                    deleteNews(newsId);
                });
            });
        }

        async function approveUser(userId) {
            try {
                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/users/${userId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                // Show success message with preview link
                const userAlert = document.getElementById('userAlert');
                userAlert.innerHTML = `
                    User approved successfully! 
                    <a href="${data.emailPreviewUrl}" target="_blank" style="color: blue; text-decoration: underline;">
                        View Email
                    </a>
                `;
                userAlert.style.display = 'block';

                // Refresh user list
                loadUsers();

                // Hide alert after 10 seconds
                setTimeout(() => {
                    userAlert.style.display = 'none';
                }, 10000);

            } catch (error) {
                console.error('Failed to approve user:', error);
                alert('Failed to approve user. Please try again.');
            }
        }

        async function revokeAccess(userId) {
            if (!confirm('Are you sure you want to revoke this user\'s access? They will no longer be able to use the mobile app.')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/users/${userId}/revoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error('Failed to revoke access');

                // Show success message
                const userAlert = document.getElementById('userAlert');
                userAlert.textContent = 'User access revoked successfully';
                userAlert.style.display = 'block';

                // Refresh user list
                loadUsers();

                // Hide alert after 3 seconds
                setTimeout(() => {
                    userAlert.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('Failed to revoke access:', error);
                alert('Failed to revoke user access. Please try again.');
            }
        }

        // User Management Functions
        async function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const site = document.getElementById('userSite').value.trim();
            const role = document.getElementById('userRole').value;

            if (!name || !email || !site) {
                showAlert('userAlert', 'Please fill in all required fields', 'error');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('userAlert', 'Please enter a valid email address', 'error');
                return;
            }

            try {
                // Determine if we're adding or editing
                const isEditing = editingUserId !== null;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `http://localhost:5000/api/users/${editingUserId}` : 'http://localhost:5000/api/users';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, site, role })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('userAlert', `User ${isEditing ? 'updated' : 'added'} successfully!`, 'success');

                    // Clear form
                    cancelUserEdit();

                    // Refresh user list
                    loadUsers();
                } else {
                    showAlert('userAlert', data.message || `Failed to ${isEditing ? 'update' : 'add'} user`, 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showAlert('userAlert', 'Error adding user. Please try again.', 'error');
            }
        }

        function cancelUserEdit() {
            // Clear form
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userSite').value = '';
            document.getElementById('userRole').value = 'user';

            // Reset form title and button
            document.getElementById('userFormTitle').textContent = 'Add New User';
            document.getElementById('saveUserBtn').textContent = 'Add User';
            document.getElementById('cancelUserEditBtn').style.display = 'none';

            // Reset editing state
            editingUserId = null;
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                // Note: The backend DELETE endpoint requires authentication, but for testing we'll try without it
                const response = await fetch(`http://localhost:5000/api/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('userAlert', 'User deleted successfully!', 'success');
                    // Refresh user list
                    loadUsers();
                } else {
                    const errorData = await response.json();
                    showAlert('userAlert', errorData.message || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('userAlert', 'Error deleting user. Please try again.', 'error');
            }
        }

        function editUser(userId) {
            // Find the user data from the current users list
            const users = document.querySelectorAll('#usersTableBody tr');
            let userData = null;

            // Since we don't have direct access to the user data, we need to fetch it
            // For now, let's load all users and find the one we want to edit
            fetch('http://localhost:5000/api/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.users) {
                        const user = data.users.find(u => u.id === userId);
                        if (user) {
                            // Populate form with user data
                            document.getElementById('userName').value = user.name || '';
                            document.getElementById('userEmail').value = user.email || '';
                            document.getElementById('userSite').value = user.site || '';
                            document.getElementById('userRole').value = user.role || 'user';

                            // Update form state
                            document.getElementById('userFormTitle').textContent = 'Edit User';
                            document.getElementById('saveUserBtn').textContent = 'Update User';
                            document.getElementById('cancelUserEditBtn').style.display = 'inline-block';

                            // Set editing state
                            editingUserId = userId;

                            // Scroll to form
                            document.querySelector('.news-form').scrollIntoView({ behavior: 'smooth' });
                        } else {
                            showAlert('userAlert', 'User not found', 'error');
                        }
                    } else {
                        showAlert('userAlert', 'Failed to load user data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading user:', error);
                    showAlert('userAlert', 'Failed to load user data', 'error');
                });
        }

        // ============================================================================
        // CLINICAL TRIALS FUNCTIONS
        // ============================================================================

        async function loadTrials() {
            try {
                const response = await fetch('http://localhost:5000/api/clinical-trials');
                const data = await response.json();

                if (response.ok && data.success) {
                    updateTrialsTable(data.trials);
                } else {
                    showAlert('trialAlert', data.message || 'Failed to load trials', 'error');
                }
            } catch (error) {
                console.error('Error loading trials:', error);
                showAlert('trialAlert', 'Error loading trials. Please try again.', 'error');
            }
        }

        function updateTrialsTable(trials) {
            const tableBody = document.getElementById('trialsTableBody');

            if (trials.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">No clinical trials found</td></tr>';
                return;
            }

            tableBody.innerHTML = trials.map(trial => `
                <tr>
                    <td>${trial.trial_name || ''}</td>
                    <td>${trial.description ? trial.description.substring(0, 100) + (trial.description.length > 100 ? '...' : '') : ''}</td>
                    <td>
                        <span class="status-badge status-${trial.status || 'active'}">
                            ${(trial.status || 'active').charAt(0).toUpperCase() + (trial.status || 'active').slice(1)}
                        </span>
                    </td>
                    <td>${trial.start_date ? new Date(trial.start_date).toLocaleDateString() : ''}</td>
                    <td>${trial.end_date ? new Date(trial.end_date).toLocaleDateString() : ''}</td>
                    <td>
                        <button onclick="editTrial('${trial.id}')" class="btn-small">Edit</button>
                        <button onclick="deleteTrial('${trial.id}')" class="btn-delete">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveTrial() {
            const trialName = document.getElementById('trialName').value.trim();
            const description = document.getElementById('trialDescription').value.trim();
            const status = document.getElementById('trialStatus').value;
            const startDate = document.getElementById('trialStartDate').value;
            const endDate = document.getElementById('trialEndDate').value;

            if (!trialName) {
                showAlert('trialAlert', 'Please enter a trial name', 'error');
                return;
            }

            try {
                // Determine if we're adding or editing
                const isEditing = editingTrialId !== null;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `http://localhost:5000/api/clinical-trials/${editingTrialId}` : 'http://localhost:5000/api/clinical-trials';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trial_name: trialName,
                        description: description,
                        status: status,
                        start_date: startDate || null,
                        end_date: endDate || null
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('trialAlert', `Clinical trial ${isEditing ? 'updated' : 'added'} successfully!`, 'success');

                    // Clear form
                    cancelTrialEdit();

                    // Refresh trials list
                    loadTrials();
                } else {
                    showAlert('trialAlert', data.message || `Failed to ${isEditing ? 'update' : 'add'} trial`, 'error');
                }
            } catch (error) {
                console.error('Error saving trial:', error);
                showAlert('trialAlert', 'Error saving trial. Please try again.', 'error');
            }
        }

        function editTrial(trialId) {
            // Fetch trial data
            fetch('http://localhost:5000/api/clinical-trials')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.trials) {
                        const trial = data.trials.find(t => t.id === trialId);
                        if (trial) {
                            // Populate form with trial data
                            document.getElementById('trialName').value = trial.trial_name || '';
                            document.getElementById('trialDescription').value = trial.description || '';
                            document.getElementById('trialStatus').value = trial.status || 'active';
                            document.getElementById('trialStartDate').value = trial.start_date ? trial.start_date.split('T')[0] : '';
                            document.getElementById('trialEndDate').value = trial.end_date ? trial.end_date.split('T')[0] : '';

                            // Update form state
                            document.getElementById('trialFormTitle').textContent = 'Edit Clinical Trial';
                            document.getElementById('saveTrialBtn').textContent = 'Update Trial';
                            document.getElementById('cancelTrialEditBtn').style.display = 'inline-block';

                            // Set editing state
                            editingTrialId = trialId;

                            // Scroll to form
                            document.querySelector('#tab3 .news-form').scrollIntoView({ behavior: 'smooth' });
                        } else {
                            showAlert('trialAlert', 'Trial not found', 'error');
                        }
                    } else {
                        showAlert('trialAlert', 'Failed to load trial data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading trial:', error);
                    showAlert('trialAlert', 'Failed to load trial data', 'error');
                });
        }

        async function deleteTrial(trialId) {
            if (!confirm('Are you sure you want to delete this clinical trial? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/clinical-trials/${trialId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('trialAlert', 'Clinical trial deleted successfully!', 'success');
                    // Refresh trials list
                    loadTrials();
                } else {
                    const errorData = await response.json();
                    showAlert('trialAlert', errorData.message || 'Failed to delete trial', 'error');
                }
            } catch (error) {
                console.error('Error deleting trial:', error);
                showAlert('trialAlert', 'Error deleting trial. Please try again.', 'error');
            }
        }

        function cancelTrialEdit() {
            // Clear form
            document.getElementById('trialName').value = '';
            document.getElementById('trialDescription').value = '';
            document.getElementById('trialStatus').value = 'active';
            document.getElementById('trialStartDate').value = '';
            document.getElementById('trialEndDate').value = '';

            // Reset form title and button
            document.getElementById('trialFormTitle').textContent = 'Add New Clinical Trial';
            document.getElementById('saveTrialBtn').textContent = 'Add Trial';
            document.getElementById('cancelTrialEditBtn').style.display = 'none';

            // Reset editing state
            editingTrialId = null;
        }

        let editingNewsId = null;
        let editingUserId = null;
        let editingTrialId = null;

        // ============================================================================
        // CLINICAL TRIALS DROPDOWN FUNCTIONS
        // ============================================================================

        function toggleTrialsDropdown() {
            const dropdown = document.querySelector('.clinical-trials-dropdown');
            const isActive = dropdown.classList.contains('active');

            if (isActive) {
                closeTrialsDropdown();
            } else {
                openTrialsDropdown();
            }
        }

        function openTrialsDropdown() {
            const dropdown = document.querySelector('.clinical-trials-dropdown');
            dropdown.classList.add('active');

            // Load trials data
            loadTrialsForDropdown();

            // Add click outside listener
            document.addEventListener('click', handleTrialsDropdownClickOutside);
        }

        function closeTrialsDropdown() {
            const dropdown = document.querySelector('.clinical-trials-dropdown');
            dropdown.classList.remove('active');

            // Remove click outside listener
            document.removeEventListener('click', handleTrialsDropdownClickOutside);
        }

        function handleTrialsDropdownClickOutside(event) {
            const dropdown = document.querySelector('.clinical-trials-dropdown');
            if (!dropdown.contains(event.target)) {
                closeTrialsDropdown();
            }
        }

        async function loadTrialsForDropdown() {
            try {
                const response = await fetch('http://localhost:5000/api/clinical-trials');
                const data = await response.json();

                if (response.ok && data.success) {
                    populateTrialsDropdown(data.trials);
                } else {
                    document.getElementById('trialList').innerHTML = '<div class="trial-loading">Failed to load trials</div>';
                }
            } catch (error) {
                console.error('Error loading trials for dropdown:', error);
                document.getElementById('trialList').innerHTML = '<div class="trial-loading">Error loading trials</div>';
            }
        }

        function populateTrialsDropdown(trials) {
            const trialList = document.getElementById('trialList');
            const trialCount = document.getElementById('trialCount');

            // Update count
            trialCount.textContent = trials.length;

            if (trials.length === 0) {
                trialList.innerHTML = '<div class="trial-loading">No clinical trials found</div>';
                return;
            }

            // Create trial items
            const trialItems = trials.slice(0, 10).map(trial => `
                <div class="trial-item" onclick="showTab(3)">
                    <span class="trial-name">${trial.trial_name || 'Unnamed Trial'}</span>
                    <span class="trial-status status-${trial.status || 'active'}">
                        ${trial.status || 'active'}
                    </span>
                </div>
            `).join('');

            trialList.innerHTML = trialItems;
        }

        async function loadNewsItems() {
            try {
                // Temporary: Remove authentication for testing
                const response = await fetch('http://localhost:5000/api/news', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateNewsList(data.newsItems);
                } else {
                    updateNewsList([]);
                }
            } catch (error) {
                console.error('Error loading news items:', error);
                updateNewsList([]);
            }
        }

        async function saveNews() {
            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            
            if (!title || !content) {
                showAlert('newsAlert', 'Please fill in all fields', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const isEditing = editingNewsId !== null;
                const url = isEditing
                    ? `http://localhost:5000/api/news/${editingNewsId}`
                    : 'http://localhost:5000/api/news';
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title, content })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert('newsAlert', `News ${isEditing ? 'updated' : 'added'} successfully!`, 'success');

                    // Clear form and reset editing state
                    cancelNewsEdit();
                    loadNewsItems(); // Refresh news data
                } else {
                    showAlert('newsAlert', data.message || `Failed to ${isEditing ? 'update' : 'add'} news`, 'error');
                }
            } catch (error) {
                showAlert('newsAlert', `Error ${editingNewsId ? 'updating' : 'adding'} news`, 'error');
                console.error('Error:', error);
            }
        }

        function editNews(newsId, title, content) {
            // Set editing mode
            editingNewsId = newsId;
            
            // Update form title and button
            document.getElementById('newsFormTitle').textContent = 'Edit News Item';
            document.getElementById('newsSubmitBtn').textContent = 'Update News';
            document.getElementById('newsCancelBtn').style.display = 'inline-block';
            
            // Populate form with existing data
            document.getElementById('newsTitle').value = title;
            document.getElementById('newsContent').value = content;
            
            // Scroll to form
            document.getElementById('newsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelNewsEdit() {
            // Reset editing state
            editingNewsId = null;
            
            // Reset form title and button
            document.getElementById('newsFormTitle').textContent = 'Add News Item';
            document.getElementById('newsSubmitBtn').textContent = 'Add News';
            document.getElementById('newsCancelBtn').style.display = 'none';
            
            // Clear form
            document.getElementById('newsTitle').value = '';
            document.getElementById('newsContent').value = '';
        }

        async function deleteNews(newsId) {
            if (!confirm('Are you sure you want to delete this news item?')) return;

            try {
                const response = await fetch(`http://localhost:5000/api/news/${newsId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('newsAlert', 'News item deleted successfully!', 'success');
                    loadNewsItems(); // Refresh news data
                } else {
                    showAlert('newsAlert', data.message || 'Failed to delete news item', 'error');
                }
            } catch (error) {
                showAlert('newsAlert', 'Error deleting news item', 'error');
                console.error('Error:', error);
            }
        }

        // PDF Management Functions
        async function addPDFDocument() {
            const title = document.getElementById('pdfTitle').value;
            const description = document.getElementById('pdfDescription').value;
            const category = document.getElementById('pdfCategory').value;
            const fileInput = document.getElementById('pdfFile');
            
            if (!title || !description || !fileInput.files[0]) {
                showAlert('newsAlert', 'Please fill in all fields and select a PDF file', 'error');
                return;
            }

            try {
                // For now, we'll simulate PDF upload by sending metadata
                // In production, you'd handle file upload properly
                const pdfData = {
                    title,
                    description,
                    category: category || 'General',
                    filename: fileInput.files[0].name,
                    size: fileInput.files[0].size,
                    uploadDate: new Date().toISOString()
                };

                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/pdfs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(pdfData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('newsAlert', 'PDF document added successfully!', 'success');
                    // Clear form
                    document.getElementById('pdfTitle').value = '';
                    document.getElementById('pdfDescription').value = '';
                    document.getElementById('pdfCategory').value = '';
                    document.getElementById('pdfFile').value = '';
                    loadPDFDocuments(); // Refresh PDFs
                } else {
                    showAlert('newsAlert', data.error || 'Failed to add PDF', 'error');
                }
            } catch (error) {
                showAlert('newsAlert', 'Error adding PDF document', 'error');
                console.error('Error:', error);
            }
        }

        async function loadPDFDocuments() {
            try {
                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/pdfs`);
                const data = await response.json();
                
                if (response.ok) {
                    updatePDFsList(data.pdfs);
                } else {
                    console.error('Failed to load PDFs:', data.error);
                }
            } catch (error) {
                console.error('Error loading PDFs:', error);
            }
        }

        function updatePDFsList(pdfs) {
            const pdfsList = document.getElementById('pdfItemsList');
            
            if (pdfs.length === 0) {
                pdfsList.innerHTML = '<p>No PDF documents found</p>';
                return;
            }

            pdfsList.innerHTML = pdfs.map(pdf => `
                <div class="pdf-item">
                    <div class="pdf-info">
                        <h5>${pdf.title}</h5>
                        <p style="color: #666; margin-bottom: 0.5rem;">${pdf.description}</p>
                        <div>
                            <span class="category-badge">${pdf.category}</span>
                            <small style="color: #999;">${pdf.filename} â€¢ ${new Date(pdf.uploadDate).toLocaleDateString()}</small>
                        </div>
                    </div>
                    <div class="pdf-actions">
                        <button class="btn btn-primary" onclick="viewPDF('${pdf.id}', '${pdf.filename}', '${pdf.title}')">View PDF</button>
                        <button class="btn btn-secondary" onclick="downloadPDF('${pdf.id}', '${pdf.filename}')">Download</button>
                        <button class="btn btn-reject" onclick="deletePDF('${pdf.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function deletePDF(pdfId) {
            if (!confirm('Are you sure you want to delete this PDF document?')) return;

            try {
                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/pdfs/${pdfId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('newsAlert', 'PDF document deleted successfully!', 'success');
                    loadPDFDocuments(); // Refresh PDFs
                } else {
                    showAlert('newsAlert', data.error || 'Failed to delete PDF', 'error');
                }
            } catch (error) {
                showAlert('newsAlert', 'Error deleting PDF document', 'error');
                console.error('Error:', error);
            }
        }

        // PDF Viewing Functions
        let currentPDFId = null;
        let currentPDFFilename = null;

        function viewPDF(pdfId, filename, title) {
            currentPDFId = pdfId;
            currentPDFFilename = filename;
            
            // Set modal title
            document.getElementById('pdfModalTitle').textContent = `Viewing: ${title}`;
            
            // Create PDF viewer URL - using Google Docs viewer as a fallback
            const pdfUrl = `http://localhost:3000/api/company/${currentCompany}/pdfs/${pdfId}/file`;
            const googleDocsUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(pdfUrl)}&embedded=true`;
            
            // Try to load the PDF directly first, fallback to Google Docs viewer
            const iframe = document.getElementById('pdfViewerFrame');
            iframe.src = pdfUrl;
            
            // Show the modal
            document.getElementById('pdfViewerModal').style.display = 'block';
            
            // Handle iframe load errors and fallback to Google Docs viewer
            iframe.onerror = function() {
                iframe.src = googleDocsUrl;
            };
        }

        function closePDFViewer() {
            document.getElementById('pdfViewerModal').style.display = 'none';
            document.getElementById('pdfViewerFrame').src = '';
            currentPDFId = null;
            currentPDFFilename = null;
        }

        async function downloadPDF(pdfId, filename) {
            try {
                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/pdfs/${pdfId}/file`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    showAlert('newsAlert', 'Failed to download PDF', 'error');
                }
            } catch (error) {
                showAlert('newsAlert', 'Error downloading PDF', 'error');
                console.error('Error:', error);
            }
        }

        function downloadCurrentPDF() {
            if (currentPDFId && currentPDFFilename) {
                downloadPDF(currentPDFId, currentPDFFilename);
            }
        }

        // Leaderboard Functions
        async function loadLeaderboard() {
            try {
                // Temporary: Remove authentication for testing
                const response = await fetch('http://localhost:5000/api/hospitals', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateLeaderboard(data);
                } else {
                    updateLeaderboard({ hospitals: [], summary: { totalConsented: 0, totalRandomized: 0, totalHospitals: 0 } });
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                updateLeaderboard({ hospitals: [], summary: { totalConsented: 0, totalRandomized: 0, totalHospitals: 0 } });
            }
        }

        function updateLeaderboardTable(hospitals) {
            const tbody = document.getElementById('leaderboardTableBody');

            if (!hospitals || hospitals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No hospitals found</td></tr>';
                return;
            }

            tbody.innerHTML = hospitals.map((hospital, index) => `
                <tr data-hospital-id="${hospital.id}">
                    <td>${index + 1} ${getTrophyEmoji(index)}</td>
                    <td>${hospital.name}</td>
                    <td>${hospital.location}</td>
                    <td>${hospital.principal_investigator}</td>
                    <td>${hospital.consented_patients}</td>
                    <td>${hospital.randomized_patients}</td>
                    <td>${hospital.consent_rate}%</td>
                    <td>
                        <button onclick="editHospital('${hospital.id}')" class="btn-small">Edit</button>
                        <button onclick="deleteHospital('${hospital.id}')" class="btn-delete">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function getTrophyEmoji(index) {
            switch (index) {
                case 0: return 'ðŸ†';
                case 1: return 'ðŸ¥ˆ';
                case 2: return 'ðŸ¥‰';
                default: return '';
            }
        }

        function updateLeaderboard(data) {
            // Update summary stats
            document.getElementById('totalConsented').textContent = data.summary.totalConsented;
            document.getElementById('totalRandomized').textContent = data.summary.totalRandomized;
            document.getElementById('totalHospitals').textContent = data.summary.totalHospitals;

            // Update leaderboard table
            const tbody = document.getElementById('leaderboardTableBody');
            
            if (data.hospitals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No hospitals found</td></tr>';
                return;
            }

            // Sort by consented patients (descending)
            const sortedHospitals = data.hospitals.sort((a, b) => b.consented_patients - a.consented_patients);

            tbody.innerHTML = sortedHospitals.map((hospital, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const medal = rank === 1 ? 'ðŸ¥‡' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : rank;
                
                return `
                    <tr class="${rankClass}" data-hospital-id="${hospital.id}">
                        <td style="font-weight: bold;">${medal}</td>
                        <td>${hospital.name}</td>
                        <td>${hospital.location}</td>
                        <td>${hospital.principal_investigator}</td>
                        <td style="font-weight: bold; color: #1976d2;">${hospital.consented_patients}</td>
                        <td>${hospital.randomized_patients}</td>
                        <td>${hospital.consent_rate}%</td>
                        <td>
                            <button class="btn-edit" onclick="editHospital('${hospital.id}')">Edit</button>
                            <button class="btn-delete" onclick="deleteHospital('${hospital.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editHospital(hospitalId) {
            console.log('ðŸ“ Editing hospital:', hospitalId);
            
            // Find the table row with this hospital ID
            const row = document.querySelector(`tr[data-hospital-id="${hospitalId}"]`);
            if (!row) {
                console.error('âŒ Could not find hospital row');
                return;
            }
            
            // Extract data from the table cells
            const cells = row.querySelectorAll('td');
            const hospitalData = {
                name: cells[1].textContent,
                location: cells[2].textContent,
                principalInvestigator: cells[3].textContent,
                consentedPatients: parseInt(cells[4].textContent),
                randomizedPatients: parseInt(cells[5].textContent),
                consentRate: parseFloat(cells[6].textContent)
            };
            
            console.log('ðŸ“‹ Hospital data:', hospitalData);
            
            // Populate the form
            document.getElementById('hospitalName').value = hospitalData.name;
            document.getElementById('hospitalLocation').value = hospitalData.location;
            document.getElementById('principalInvestigator').value = hospitalData.principalInvestigator;
            document.getElementById('consentedPatients').value = hospitalData.consentedPatients;
            document.getElementById('randomizedPatients').value = hospitalData.randomizedPatients;
            document.getElementById('consentRate').value = hospitalData.consentRate;
            
            // Update form state
            editingHospitalId = hospitalId;
            document.getElementById('hospitalFormTitle').textContent = 'Edit Hospital';
            document.getElementById('saveHospitalBtn').textContent = 'Update Hospital';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
            
            // Add visual feedback
            document.querySelectorAll('.leaderboard-table tr').forEach(tr => {
                if (tr.dataset.hospitalId === hospitalId) {
                    tr.classList.add('editing-row');
                } else {
                    tr.classList.add('other-rows');
                }
            });
            
            // Scroll to form
            document.querySelector('.news-form').scrollIntoView({ behavior: 'smooth' });
            
            console.log('âœ… Edit mode activated');
        }

        function cancelEdit() {
            // Clear form
            document.getElementById('hospitalName').value = '';
            document.getElementById('hospitalLocation').value = '';
            document.getElementById('principalInvestigator').value = '';
            document.getElementById('consentedPatients').value = '';
            document.getElementById('randomizedPatients').value = '';
            document.getElementById('consentRate').value = '';
            
            // Reset form state
            editingHospitalId = null;
            document.getElementById('hospitalFormTitle').textContent = 'Add New Hospital';
            document.getElementById('saveHospitalBtn').textContent = 'Add Hospital';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            // Remove visual feedback
            document.querySelectorAll('.leaderboard-table tr').forEach(tr => {
                tr.classList.remove('editing-row', 'other-rows');
            });
        }

        async function saveHospital() {
            if (!currentCompany) {
                showAlert('leaderboardAlert', 'Error: No company selected', 'error');
                return;
            }

            const hospitalData = {
                name: document.getElementById('hospitalName').value,
                location: document.getElementById('hospitalLocation').value,
                principalInvestigator: document.getElementById('principalInvestigator').value,
                consentedPatients: parseInt(document.getElementById('consentedPatients').value) || 0,
                randomizedPatients: parseInt(document.getElementById('randomizedPatients').value) || 0,
                consentRate: parseFloat(document.getElementById('consentRate').value) || 0
            };
            
            if (!hospitalData.name || !hospitalData.location || !hospitalData.principalInvestigator) {
                showAlert('leaderboardAlert', 'Please fill in all required fields', 'error');
                return;
            }

            try {

                const token = localStorage.getItem('token');
                const isEditing = editingHospitalId !== null;
                const url = isEditing
                    ? `http://localhost:5000/api/hospitals/${editingHospitalId}`
                    : 'http://localhost:5000/api/hospitals';
                const method = isEditing ? 'PUT' : 'POST';


                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: hospitalData.name,
                        location: hospitalData.location,
                        principalInvestigator: hospitalData.principalInvestigator,
                        consentedPatients: hospitalData.consentedPatients,
                        randomizedPatients: hospitalData.randomizedPatients,
                        consentRate: hospitalData.consentRate
                    })
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    
                    // Check if response is HTML (error page)
                    if (response.headers.get('content-type')?.includes('text/html')) {
                        console.error('âŒ Server returned HTML instead of JSON - likely a 404 or server error');
                        showAlert('leaderboardAlert', 'Server endpoint not found. Please restart the server with updated code.', 'error');
                        return;
                    }
                    
                    showAlert('leaderboardAlert', 'Invalid response from server', 'error');
                    return;
                }
                
                if (response.ok && data.success) {
                    showAlert('leaderboardAlert', `Hospital ${isEditing ? 'updated' : 'added'} successfully!`, 'success');

                    // Clear form and reload data
                    if (isEditing) {
                        cancelEdit();
                    } else {
                        document.getElementById('hospitalName').value = '';
                        document.getElementById('hospitalLocation').value = '';
                        document.getElementById('principalInvestigator').value = '';
                        document.getElementById('consentedPatients').value = '';
                        document.getElementById('randomizedPatients').value = '';
                        document.getElementById('consentRate').value = '';
                    }

                    loadLeaderboard(); // Refresh leaderboard
                } else {
                    console.error('âŒ Server error:', data.error);
                    showAlert('leaderboardAlert', data.error || 'Failed to save hospital', 'error');
                }
            } catch (error) {
                console.error('âŒ Network error:', error.message);
                showAlert('leaderboardAlert', `Network error: ${error.message}`, 'error');
            }
        }

        async function deleteHospital(hospitalId) {
            if (!confirm('Are you sure you want to delete this hospital?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:5000/api/hospitals/${hospitalId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showAlert('leaderboardAlert', 'Hospital deleted successfully!', 'success');
                    loadLeaderboard(); // Refresh leaderboard
                } else {
                    showAlert('leaderboardAlert', data.error || 'Failed to delete hospital', 'error');
                }
            } catch (error) {
                showAlert('leaderboardAlert', 'Error deleting hospital', 'error');
                console.error('Error:', error);
            }
        }

        // Debug Functions
        function updateDebugInfo() {
            // Update logo debug info
            const logoDebug = document.getElementById('logoDebugInfo');
            const logoImg = document.getElementById('companyLogo');
            logoDebug.textContent = `
Logo Source: ${logoImg.src}
Logo Display: ${logoImg.style.display}
Logo Natural Width: ${logoImg.naturalWidth}
Logo Natural Height: ${logoImg.naturalHeight}
Company Info: ${JSON.stringify(companyInfo, null, 2)}
            `;

            // Update company debug info
            const companyDebug = document.getElementById('companyDebugInfo');
            companyDebug.textContent = `
Current Company: ${currentCompany}
Company Info: ${JSON.stringify(companyInfo, null, 2)}
LocalStorage: ${localStorage.getItem('companyInfo')}
            `;
        }

        async function testLogoAccess() {
            const results = document.getElementById('logoTestResults') || document.getElementById('logoDebugInfo');
            
            try {
                // Test logos health endpoint
                const healthResponse = await fetch('http://localhost:3000/logos-health');
                const healthData = await healthResponse.json();
                
                // Test specific logo
                const logoResponse = await fetch(`http://localhost:3000/test-logo/${currentCompany}-logo.png`);
                const logoExists = logoResponse.ok;
                
                const resultText = `
ðŸ¥ Logo Directory Health: ${healthResponse.ok ? 'âœ… OK' : 'âŒ Failed'}
ðŸ“ Logo Files Found: ${healthData.files?.length || 0}
ðŸ–¼ï¸ Current Logo Test: ${logoExists ? 'âœ… Found' : 'âŒ Not Found'}
ðŸ“‹ Available Logos: ${JSON.stringify(healthData.files || [], null, 2)}
                `;
                
                if (results.tagName === 'PRE') {
                    results.textContent = resultText;
                } else {
                    results.innerHTML = `<pre>${resultText}</pre>`;
                }
            } catch (error) {
                const errorText = `âŒ Logo test failed: ${error.message}`;
                if (results.tagName === 'PRE') {
                    results.textContent = errorText;
                } else {
                    results.innerHTML = `<pre>${errorText}</pre>`;
                }
            }
        }

        async function testServerConnectivity() {
            const results = document.getElementById('apiTestResults');
            
            try {
                // Test health endpoint
                const healthResponse = await fetch('http://localhost:3000/health');
                const healthData = await healthResponse.json();
                
                // Test company-specific endpoints
                const dashboardResponse = await fetch(`http://localhost:3000/api/company/${currentCompany}/dashboard`);
                const dashboardOk = dashboardResponse.ok;
                
                const hospitalsResponse = await fetch(`http://localhost:3000/api/company/${currentCompany}/hospitals`);
                const hospitalsOk = hospitalsResponse.ok;
                
                results.textContent = `
ðŸ¥ Server Health: ${healthResponse.ok ? 'âœ… OK' : 'âŒ Failed'}
ðŸ“Š Dashboard API: ${dashboardOk ? 'âœ… OK' : 'âŒ Failed'}
ðŸ¥ Hospitals API: ${hospitalsOk ? 'âœ… OK' : 'âŒ Failed'}
ðŸ”§ Server Info: ${JSON.stringify(healthData, null, 2)}
                `;
            } catch (error) {
                results.textContent = `âŒ Server connectivity test failed: ${error.message}`;
            }
        }

        async function testHospitalAPI() {
            const results = document.getElementById('apiTestResults');
            
            try {
                // Test GET hospitals
                const getResponse = await fetch(`http://localhost:3000/api/company/${currentCompany}/hospitals`);
                const getOk = getResponse.ok;
                let getCount = 0;
                
                if (getOk) {
                    const getData = await getResponse.json();
                    getCount = getData.hospitals?.length || 0;
                }
                
                // Test POST with dummy data
                const testHospital = {
                    name: 'Test Hospital',
                    location: 'Test City',
                    principalInvestigator: 'Dr. Test',
                    consentedPatients: 1,
                    randomizedPatients: 1,
                    consentRate: 1.0
                };
                
                const postResponse = await fetch(`http://localhost:3000/api/company/${currentCompany}/hospitals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testHospital)
                });
                const postOk = postResponse.ok;
                
                // If we created a test hospital, delete it
                if (postOk) {
                    const postData = await postResponse.json();
                    if (postData.hospital?.id) {
                        await fetch(`http://localhost:3000/api/company/${currentCompany}/hospitals/${postData.hospital.id}`, {
                            method: 'DELETE'
                        });
                    }
                }
                
                results.textContent = `
ðŸ“Š GET Hospitals: ${getOk ? 'âœ… OK' : 'âŒ Failed'}
ðŸ“‹ Current Hospital Count: ${getCount}
âž• POST Hospital Test: ${postOk ? 'âœ… OK' : 'âŒ Failed'}
ðŸ—‘ï¸ Cleanup: ${postOk ? 'âœ… Test hospital removed' : 'N/A'}
                `;
            } catch (error) {
                results.textContent = `âŒ Hospital API test failed: ${error.message}`;
            }
        }

        async function testBasicEndpoint() {
            const results = document.getElementById('apiTestResults');
            
            try {
                const response = await fetch('http://localhost:3000/test');
                const data = await response.json();
                
                results.textContent = `
ðŸ” Basic Test Endpoint: ${response.ok ? 'âœ… OK' : 'âŒ Failed'}
ðŸ“‹ Response: ${JSON.stringify(data, null, 2)}
                `;
            } catch (error) {
                results.textContent = `âŒ Basic endpoint test failed: ${error.message}`;
            }
        }

        async function checkAvailableEndpoints() {
            const results = document.getElementById('apiTestResults');
            
            const endpoints = [
                '/api/backup',
                '/api/emergency-export',
                '/api/restore-data',
                '/test',
                '/health',
                `/api/company/${currentCompany}/hospitals`,
                `/api/company/${currentCompany}/leaderboard`
            ];
            
            const endpointStatus = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`http://localhost:3000${endpoint}`);
                    endpointStatus.push(`${endpoint}: ${response.ok ? 'âœ…' : 'âŒ'} (${response.status})`);
                } catch (error) {
                    endpointStatus.push(`${endpoint}: âŒ (${error.message})`);
                }
            }
            
            results.textContent = `
ðŸ” Endpoint Availability Check:
${endpointStatus.join('\n')}
            `;
        }

        async function exportCurrentData() {
            const resultsDiv = document.getElementById('exportResults');

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:5000/api/emergency-export', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Create downloadable file
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup-${currentCompany}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    resultsDiv.innerHTML = '<p style="color: green;">âœ… Data exported successfully! Check your downloads.</p>';
                } else {
                    console.log('âŒ Data export failed:', response.status);
                    resultsDiv.innerHTML = `<p style="color: red;">âŒ Data export failed: ${response.status}</p>`;
                }
            } catch (error) {
                console.error('âŒ Data export error:', error.message);
                resultsDiv.innerHTML = `<p style="color: red;">âŒ Data export failed: ${error.message}</p>`;
            }
        }

        function showRestoreForm() {
            document.getElementById('restoreForm').style.display = 'block';
        }

        function hideRestoreForm() {
            document.getElementById('restoreForm').style.display = 'none';
            document.getElementById('restoreDataTextarea').value = '';
        }

        async function restoreData() {
            const dataText = document.getElementById('restoreDataTextarea').value;
            const resultsDiv = document.getElementById('exportResults');
            
            if (!dataText.trim()) {
                resultsDiv.innerHTML = '<p style="color: red;">âŒ Please paste backup data first</p>';
                return;
            }
            
            try {
                // Validate JSON
                const backupData = JSON.parse(dataText);

                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:5000/api/restore-data', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: dataText
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = '<p style="color: green;">âœ… Data restored successfully!</p>';
                    hideRestoreForm();
                    
                    // Refresh all data
                    setTimeout(() => {
                        loadDashboardData();
                        loadPDFDocuments();
                        loadLeaderboard();
                    }, 1000);
                } else {
                    resultsDiv.innerHTML = `<p style="color: red;">âŒ Restore failed: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('âŒ Restore error:', error);
                resultsDiv.innerHTML = `<p style="color: red;">âŒ Invalid JSON or restore failed: ${error.message}</p>`;
            }
        }

        async function exportFromLeaderboard() {
            const resultsDiv = document.getElementById('exportResults');
            
            try {
                const table = document.getElementById('leaderboardTableBody');
                const rows = table.querySelectorAll('tr[data-hospital-id]');
                
                const hospitals = [];
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        hospitals.push({
                            id: row.dataset.hospitalId,
                            name: cells[1].textContent.trim(),
                            location: cells[2].textContent.trim(),
                            principalInvestigator: cells[3].textContent.trim(),
                            consentedPatients: parseInt(cells[4].textContent) || 0,
                            randomizedPatients: parseInt(cells[5].textContent) || 0,
                            consentRate: parseFloat(cells[6].textContent) || 0
                        });
                    }
                });
                
                const exportData = {
                    exportType: 'leaderboard-client-side',
                    exportDate: new Date().toISOString(),
                    company: currentCompany,
                    hospitals: hospitals,
                    summary: {
                        totalHospitals: hospitals.length,
                        totalConsented: hospitals.reduce((sum, h) => sum + h.consentedPatients, 0),
                        totalRandomized: hospitals.reduce((sum, h) => sum + h.randomizedPatients, 0)
                    }
                };
                
                console.log('ðŸ“Š Extracted data:', exportData);
                
                // Create downloadable file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `leaderboard-backup-${currentCompany}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                resultsDiv.innerHTML = `<p style="color: green;">âœ… Found ${hospitals.length} hospitals. Data exported successfully! Check your downloads.</p>`;
            } catch (error) {
                console.error('âŒ Client-side export error:', error);
                resultsDiv.innerHTML = `<p style="color: red;">âŒ Export failed: ${error.message}</p>`;
            }
        }

        // Training Materials Functions
        function showTrainingContentTab(tabName) {
            // Hide all content sections
            document.querySelectorAll('#tab3 .content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('#tab3 .content-tab').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section and mark button as active
            if (tabName === 'materials') {
                document.getElementById('trainingMaterialsSection').classList.add('active');
                event.target.classList.add('active');
                loadTrainingMaterials();
            } else if (tabName === 'upload') {
                document.getElementById('trainingUploadSection').classList.add('active');
                event.target.classList.add('active');
            }
        }

        function toggleTrainingUploadOptions() {
            const type = document.getElementById('trainingType').value;
            const textSection = document.getElementById('textContentSection');
            const fileSection = document.getElementById('fileUploadSection');
            
            textSection.style.display = 'none';
            fileSection.style.display = 'none';
            
            if (type === 'text') {
                textSection.style.display = 'block';
            } else if (type === 'pdf' || type === 'video') {
                fileSection.style.display = 'block';
                const fileInput = document.getElementById('trainingFile');
                if (type === 'pdf') {
                    fileInput.accept = '.pdf';
                } else if (type === 'video') {
                    fileInput.accept = '.mp4,.avi,.mov,.wmv';
                }
            }
        }

        async function loadTrainingMaterials() {
            try {
                // Temporary: Call backend API for testing
                const response = await fetch('http://localhost:5000/api/training-materials', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateTrainingMaterialsList(data.trainingMaterials);
                } else {
                    updateTrainingMaterialsList([]);
                }
            } catch (error) {
                console.error('Error loading training materials:', error);
                updateTrainingMaterialsList([]);
            }
        }

        function updateTrainingMaterialsList(materials) {
            const list = document.getElementById('trainingMaterialsList');
            
            if (materials.length === 0) {
                list.innerHTML = '<p>No training materials found.</p>';
                return;
            }
            
            list.innerHTML = materials.map(material => `
                <div class="pdf-item">
                    <div class="pdf-info">
                        <h5>${material.title}</h5>
                        <p>${material.description}</p>
                        <small>
                            <span class="category-badge">${material.category}</span>
                            <span class="category-badge">${material.type}</span>
                            ${material.uploadDate} | Created by ${material.createdBy}
                        </small>
                        ${material.type === 'text' ? `<div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto;">${material.content}</div>` : ''}
                    </div>
                    <button class="btn-delete" onclick="deleteTrainingMaterial('${material.id}')">Delete</button>
                </div>
            `).join('');
        }

        async function addTrainingMaterial() {
            const title = document.getElementById('trainingTitle').value;
            const description = document.getElementById('trainingDescription').value;
            const type = document.getElementById('trainingType').value;
            const category = document.getElementById('trainingCategory').value;
            
            if (!title || !type) {
                showAlert('trainingAlert', 'Please fill in title and select type', 'error');
                return;
            }
            
            let content = '';
            if (type === 'text') {
                content = document.getElementById('trainingTextContent').value;
                if (!content) {
                    showAlert('trainingAlert', 'Please enter text content', 'error');
                    return;
                }
            } else {
                const fileInput = type === 'pdf' ? document.getElementById('trainingFile') : document.getElementById('trainingFile');
                if (fileInput.files.length === 0) {
                    showAlert('trainingAlert', 'Please select a file to upload', 'error');
                    return;
                }
                // For demo purposes, we'll just use the filename
                content = `Uploaded file: ${fileInput.files[0].name}`;
            }
            
            try {
                // Temporary: Call backend API for testing
                const response = await fetch('http://localhost:5000/api/training-materials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        type,
                        content,
                        category
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('trainingAlert', 'Training material added successfully!', 'success');
                    // Clear form
                    document.getElementById('trainingTitle').value = '';
                    document.getElementById('trainingDescription').value = '';
                    document.getElementById('trainingType').value = '';
                    document.getElementById('trainingTextContent').value = '';
                    document.getElementById('trainingFile').value = '';
                    document.getElementById('textContentSection').style.display = 'none';
                    document.getElementById('fileUploadSection').style.display = 'none';
                    
                    loadTrainingMaterials(); // Refresh list
                } else {
                    showAlert('trainingAlert', data.error || 'Failed to add training material', 'error');
                }
            } catch (error) {
                showAlert('trainingAlert', 'Error adding training material', 'error');
                console.error('Error:', error);
            }
        }

        async function deleteTrainingMaterial(materialId) {
            if (!confirm('Are you sure you want to delete this training material?')) return;

            try {
                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/training-materials/${materialId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('trainingAlert', 'Training material deleted successfully!', 'success');
                    loadTrainingMaterials(); // Refresh list
                } else {
                    showAlert('trainingAlert', data.error || 'Failed to delete training material', 'error');
                }
            } catch (error) {
                showAlert('trainingAlert', 'Error deleting training material', 'error');
                console.error('Error:', error);
            }
        }

        // Study Protocol Functions
        function showProtocolContentTab(tabName) {
            // Hide all content sections
            document.querySelectorAll('#tab4 .content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('#tab4 .content-tab').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section and mark button as active
            if (tabName === 'protocols') {
                document.getElementById('studyProtocolsSection').classList.add('active');
                event.target.classList.add('active');
                loadStudyProtocols();
            } else if (tabName === 'upload') {
                document.getElementById('protocolUploadSection').classList.add('active');
                event.target.classList.add('active');
            }
        }

        function toggleProtocolUploadOptions() {
            const type = document.getElementById('protocolType').value;
            const textSection = document.getElementById('protocolTextContentSection');
            const fileSection = document.getElementById('protocolFileUploadSection');
            
            textSection.style.display = 'none';
            fileSection.style.display = 'none';
            
            if (type === 'text') {
                textSection.style.display = 'block';
            } else if (type === 'pdf') {
                fileSection.style.display = 'block';
            }
        }

        async function loadStudyProtocols() {
            try {
                // Temporary: Call backend API for testing
                const response = await fetch('http://localhost:5000/api/study-protocols', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    updateStudyProtocolsList(data.studyProtocols);
                } else {
                    updateStudyProtocolsList([]);
                }
            } catch (error) {
                console.error('Error loading study protocols:', error);
                updateStudyProtocolsList([]);
            }
        }

        function updateStudyProtocolsList(protocols) {
            const list = document.getElementById('studyProtocolsList');
            
            if (protocols.length === 0) {
                list.innerHTML = '<p>No study protocols found.</p>';
                return;
            }
            
            list.innerHTML = protocols.map(protocol => `
                <div class="pdf-item">
                    <div class="pdf-info">
                        <h5>${protocol.title} <span style="color: #666; font-size: 0.8em;">v${protocol.version}</span></h5>
                        <p>${protocol.description}</p>
                        <small>
                            <span class="category-badge">${protocol.type}</span>
                            ${protocol.uploadDate} | Created by ${protocol.createdBy}
                        </small>
                        ${protocol.type === 'text' ? `<div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto;">${protocol.content}</div>` : ''}
                    </div>
                    <button class="btn-delete" onclick="deleteStudyProtocol('${protocol.id}')">Delete</button>
                </div>
            `).join('');
        }

        async function addStudyProtocol() {
            const title = document.getElementById('protocolTitle').value;
            const description = document.getElementById('protocolDescription').value;
            const type = document.getElementById('protocolType').value;
            const version = document.getElementById('protocolVersion').value;
            
            if (!title || !type) {
                showAlert('protocolAlert', 'Please fill in title and select type', 'error');
                return;
            }
            
            let content = '';
            if (type === 'text') {
                content = document.getElementById('protocolTextContent').value;
                if (!content) {
                    showAlert('protocolAlert', 'Please enter protocol content', 'error');
                    return;
                }
            } else {
                const fileInput = document.getElementById('protocolFile');
                if (fileInput.files.length === 0) {
                    showAlert('protocolAlert', 'Please select a PDF file to upload', 'error');
                    return;
                }
                // For demo purposes, we'll just use the filename
                content = `Uploaded file: ${fileInput.files[0].name}`;
            }
            
            try {
                // Temporary: Call backend API for testing
                const response = await fetch('http://localhost:5000/api/study-protocols', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        type,
                        content,
                        version
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('protocolAlert', 'Study protocol added successfully!', 'success');
                    // Clear form
                    document.getElementById('protocolTitle').value = '';
                    document.getElementById('protocolDescription').value = '';
                    document.getElementById('protocolType').value = '';
                    document.getElementById('protocolVersion').value = '1.0';
                    document.getElementById('protocolTextContent').value = '';
                    document.getElementById('protocolFile').value = '';
                    document.getElementById('protocolTextContentSection').style.display = 'none';
                    document.getElementById('protocolFileUploadSection').style.display = 'none';
                    
                    loadStudyProtocols(); // Refresh list
                } else {
                    showAlert('protocolAlert', data.error || 'Failed to add study protocol', 'error');
                }
            } catch (error) {
                showAlert('protocolAlert', 'Error adding study protocol', 'error');
                console.error('Error:', error);
            }
        }

        async function deleteStudyProtocol(protocolId) {
            if (!confirm('Are you sure you want to delete this study protocol?')) return;

            try {
                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/study-protocols/${protocolId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('protocolAlert', 'Study protocol deleted successfully!', 'success');
                    loadStudyProtocols(); // Refresh list
                } else {
                    showAlert('protocolAlert', data.error || 'Failed to delete study protocol', 'error');
                }
            } catch (error) {
                showAlert('protocolAlert', 'Error deleting study protocol', 'error');
                console.error('Error:', error);
            }
        }

        function showAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function logout() {
            localStorage.removeItem('companyInfo');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        async function loadAnalytics() {
            try {
                // Temporary: Call backend API for testing
                const response = await fetch('http://localhost:5000/api/analytics', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) throw new Error('Failed to load analytics');
                
                // Process analytics data
                const analytics = data.analytics;
                const now = new Date();
                const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                
                // Calculate summary statistics
                const totalAppOpens = analytics.reduce((sum, user) => sum + user.analytics.totalAppOpens, 0);
                const activeUsersCount = analytics.filter(user => {
                    const lastOpen = user.analytics.lastAppOpen ? new Date(user.analytics.lastAppOpen) : null;
                    return lastOpen && lastOpen > sevenDaysAgo;
                }).length;
                
                // Update summary cards
                document.getElementById('totalAppOpens').textContent = totalAppOpens;
                document.getElementById('activeUsers').textContent = activeUsersCount;
                
                // Update table
                const tableBody = document.getElementById('analyticsTableBody');
                tableBody.innerHTML = analytics.map(user => {
                    const lastActive = user.analytics.lastAppOpen 
                        ? new Date(user.analytics.lastAppOpen).toLocaleDateString()
                        : 'Never';
                    
                    // Find most viewed tab
                    const tabViews = user.analytics.tabViews;
                    const mostViewedTab = Object.entries(tabViews)
                        .sort((a, b) => b[1] - a[1])[0];
                    const mostViewedTabName = mostViewedTab ? formatTabName(mostViewedTab[0]) : 'None';
                    
                    return `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.site}</td>
                            <td>${lastActive}</td>
                            <td>${user.analytics.totalAppOpens}</td>
                            <td>${mostViewedTabName}</td>
                            <td>
                                <button onclick="showUserAnalytics('${user.id}')" class="btn-small">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
                // Show error message to user
            }
        }

        function formatTabName(tabName) {
            return tabName
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase());
        }

        async function showUserAnalytics(userId) {
            try {
                const response = await fetch(`http://localhost:3000/api/company/${currentCompany}/analytics`);
                const data = await response.json();
                
                const user = data.analytics.find(u => u.id === userId);
                if (!user) throw new Error('User not found');
                
                const modal = document.getElementById('userAnalyticsModal');
                const details = document.getElementById('userAnalyticsDetails');
                
                // Create detailed analytics view
                details.innerHTML = `
                    <h5>${user.name}</h5>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Site:</strong> ${user.site}</p>
                    <p><strong>Last Active:</strong> ${user.analytics.lastAppOpen ? new Date(user.analytics.lastAppOpen).toLocaleString() : 'Never'}</p>
                    <p><strong>Total App Opens:</strong> ${user.analytics.totalAppOpens}</p>
                    
                    <h6>Tab Views</h6>
                    <div class="user-analytics-chart" id="tabViewsChart_${userId}"></div>
                    
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Tab</th>
                                <th>Views</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(user.analytics.tabViews)
                                .map(([tab, views]) => `
                                    <tr>
                                        <td>${formatTabName(tab)}</td>
                                        <td>${views}</td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                `;
                
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Failed to load user analytics:', error);
                // Show error message to user
            }
        }

        function filterAnalytics() {
            const filter = document.getElementById('analyticsFilter').value;
            // Implement filtering logic
        }

        // Load analytics when tab is shown
        document.querySelector('.tab-button[onclick="showTab(5)"]').addEventListener('click', loadAnalytics);
    </script>
</body>
</html>